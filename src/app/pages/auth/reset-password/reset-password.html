<div class="auth-page">
    <mat-card class="auth-card">
        <mat-card-header>
            <mat-card-title>Reset Password</mat-card-title>
            <mat-card-subtitle>
                @if (mode() === 'request') {
                Enter your email to request a reset link.
                } @else {
                Set a new password for your account.
                }
            </mat-card-subtitle>
        </mat-card-header>

        @if (loading()) {
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        }

        <mat-card-content>
            <!-- MODE A: REQUEST RESET -->
            @if (mode() === 'request') {
            <form [formGroup]="requestForm" (ngSubmit)="submitRequest()" class="form">
                <mat-form-field appearance="outline" class="full">
                    <mat-label>Email</mat-label>
                    <input matInput type="email" formControlName="email" autocomplete="email" />
                    @if (requestEmailCtrl.hasError('required')) {
                    <mat-error>Email is required.</mat-error>
                    }
                    @if (requestEmailCtrl.hasError('email')) {
                    <mat-error>Enter a valid email address.</mat-error>
                    }
                </mat-form-field>

                <button mat-raised-button color="primary" type="submit" [disabled]="loading()">
                    Send reset link
                </button>

                <div class="helper">
                    <a mat-button routerLink="/auth/login">Back to sign in</a>
                </div>

                <mat-divider></mat-divider>

                <p class="hint">
                    For testing: submit your email, then check the API console logs for the reset URL and open it in the
                    browser.
                </p>
            </form>
            }

            <!-- MODE B: RESET PASSWORD -->
            @else {
            <form [formGroup]="resetForm" (ngSubmit)="submitReset()" class="form">
                <mat-form-field appearance="outline" class="full">
                    <mat-label>Email</mat-label>
                    <input matInput formControlName="email" autocomplete="email" />
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                    <mat-label>Token</mat-label>
                    <input matInput formControlName="token" />
                    <mat-hint>This comes from the reset link (query param).</mat-hint>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                    <mat-label>New password</mat-label>
                    <input matInput [type]="showPassword() ? 'text' : 'password'" formControlName="password"
                        autocomplete="new-password" />
                    <button mat-icon-button matSuffix type="button" (click)="togglePassword()"
                        [attr.aria-label]="showPassword() ? 'Hide password' : 'Show password'">
                        <mat-icon>{{ showPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
                    </button>

                    @if (passwordCtrl.hasError('required')) {
                    <mat-error>Password is required.</mat-error>
                    }
                    @if (passwordCtrl.hasError('minlength')) {
                    <mat-error>Password must be at least 6 characters.</mat-error>
                    }
                </mat-form-field>

                <mat-form-field appearance="outline" class="full">
                    <mat-label>Confirm password</mat-label>
                    <input matInput [type]="showConfirmPassword() ? 'text' : 'password'"
                        formControlName="confirmPassword" autocomplete="new-password" />
                    <button mat-icon-button matSuffix type="button" (click)="toggleConfirmPassword()"
                        [attr.aria-label]="showConfirmPassword() ? 'Hide confirm password' : 'Show confirm password'">
                        <mat-icon>{{ showConfirmPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
                    </button>

                    @if (confirmPasswordCtrl.hasError('required')) {
                    <mat-error>Confirm password is required.</mat-error>
                    }
                    @if (passwordsMismatch) {
                    <mat-error>Passwords do not match.</mat-error>
                    }
                </mat-form-field>

                <button mat-raised-button color="primary" type="submit" [disabled]="loading()">
                    Update password
                </button>

                <div class="helper">
                    <a mat-button routerLink="/auth/login">Back to sign in</a>
                </div>
            </form>
            }
        </mat-card-content>
    </mat-card>
</div>